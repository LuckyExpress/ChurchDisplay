<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<title>Page Title</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<!-- <link rel="stylesheet" type="text/css" media="screen" href="main.css" /> -->
		<link href="favicon.ico" rel="icon" type="image/x-icon" />
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
		<script src="eventsource.min.js"></script>
		<script src="/reload/reload.js"></script>
		<style>
			html {
				overflow: hidden;
			}

			body {
				margin: 0 auto;
				background-color: black;
			}

			.ul {
				object-fit: cover;
			}

			.left {
				width: 830px;
				height: 535px;
			}

			.right {
				max-width: 850px;
				height: 1080px;
				margin-left: 5px;
			}
		</style>
	</head>

	<body>
		<div style="float: left; width: 50%; padding-right: 5px;">
			<div style="float: right;">
				<div style="height: 540px;"><img id="imgUpperLeft" class="ul left" /></div>
				<div style="margin-top: 5px;"><img id="imgLowerLeft" class="ul left" /></div>
			</div>
		</div>
		<div style="float: left; width: 49.5%;"><img id="imgRight" class="ul right" /></div>
		<script type="text/javascript">
			var myPort = 3000;
			var myUrl = "http://" + location.hostname + ":" + myPort;

			// division (190522)
			let upperLeft = { id: "#imgUpperLeft", path: "/upperLeft/", files: [], index: 0, interval: 30890, timeout: null };
			let lowerLeft = { id: "#imgLowerLeft", path: "/lowerLeft/", files: [], index: 0, interval: 21234, timeout: null };
			let rightPanel = { id: "#imgRight", path: "/right/", files: [], index: 0, interval: 60567, timeout: null };

			// debug
			upperLeft.interval = 5050;
			lowerLeft.interval = 6400;
			rightPanel.interval = 7300;

			$("document").ready(function() {
				const refreshImage = (div, defaultIndex = -1) => {
					clearTimeout(div.timeout);
					var $img = $(div.id);
					var path = myUrl + div.path;
					if (div.files && div.files.length > 0) {
						$img.fadeOut(400, function() {
							if (defaultIndex !== -1 && defaultIndex < div.files.length) {
								div.index = defaultIndex;
							} else if (++div.index >= div.files.length) {
								div.index = 0;
							}
							$img.attr("src", path + div.files[div.index]);
							$img.fadeIn(300);
						});
						if (div.files.length !== 1) {
							div.timeout = setTimeout(() => refreshImage(div), div.interval);
						}
					}
				};

				var source1 = new EventSource(myUrl + "/event1");
				source1.onmessage = function(event) {
					let myObj = JSON.parse(event.data);
					upperLeft.files = myObj.files.slice();
					refreshImage(upperLeft, myObj.index);
				};

				var source2 = new EventSource(myUrl + "/event2");
				source2.onmessage = function(event) {
					let myObj = JSON.parse(event.data);
					lowerLeft.files = myObj.files.slice();
					refreshImage(lowerLeft, myObj.index);
				};

				var source3 = new EventSource(myUrl + "/event3");
				source3.onmessage = function(event) {
					let myObj = JSON.parse(event.data);
					rightPanel.files = myObj.files.slice();
					refreshImage(rightPanel, myObj.index);
				};

				const initDiv = (div, files) => {
					if (files) {
						div.files = files.slice();
						refreshImage(div, 0);
					}
				};

				fetch(myUrl + "/dir")
					.then(resp => resp.json())
					.then(data => initDiv(upperLeft, data));

				fetch(myUrl + "/dir2")
					.then(resp => resp.json())
					.then(data => initDiv(lowerLeft, data));

				fetch(myUrl + "/dir3")
					.then(resp => resp.json())
					.then(data => initDiv(rightPanel, data));

				// reload page at 4:30 everyday (180125)
				refreshPage(4, 30, 0);
				function refreshPage(hours, minutes, seconds) {
					var now = new Date();
					var then = new Date();
					if (now.getHours() > hours || (now.getHours() == hours && now.getMinutes() > minutes) || (now.getHours() == hours && now.getMinutes() == minutes && now.getSeconds() >= seconds)) {
						then.setDate(now.getDate() + 1);
					}
					then.setHours(hours);
					then.setMinutes(minutes);
					then.setSeconds(seconds);
					var timeout = then.getTime() - now.getTime();
					setTimeout(function() {
						window.location.reload(true);
					}, timeout);
				}

				//
				// websocket to update the temperature (180312)
				//
				function subscribeToWs(msg) {
					// var url = 'ws://' + location.hostname + (location.port ? ':' + location.port : '');
					var url = "ws://" + location.hostname + ":" + myPort;
					console.log(url);
					var socket = new WebSocket(url);
					var $temp = document.getElementById("temp");
					socket.onmessage = function(event) {
						var result = JSON.parse(event.data);
						$temp.innerHTML = result.value.toFixed(2);
						console.log(result);
					};
					socket.onerror = function(error) {
						console.log("webSocket Error: " + error);
					};
					socket.onopen = function(event) {
						if (msg) {
							socket.send(msg);
						}
					};
				}

				// debug
				// subscribeToWs();
			});
		</script>
	</body>
</html>
